<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astro | Criar Conta</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        body { background-color: #0B0F19; color: #FFFFFF; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .login-container { width: 100%; max-width: 400px; padding: 40px 30px; background: #111827; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .logo { width: 80px; height: 80px; background: linear-gradient(135deg, #3B82F6, #8B5CF6); border-radius: 50%; margin: 0 auto 20px; display: flex; justify-content: center; align-items: center; font-size: 40px; }
        h1 { font-weight: 600; margin-bottom: 5px; }
        p.subtitle { color: #9CA3AF; font-size: 14px; margin-bottom: 30px; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; font-size: 14px; color: #9CA3AF; margin-bottom: 8px; }
        .input-group input { width: 100%; padding: 15px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; font-size: 15px; outline: none; transition: 0.3s; }
        .input-group input:focus { border-color: #8B5CF6; }
        .btn-register { width: 100%; padding: 15px; background: linear-gradient(135deg, #3B82F6, #8B5CF6); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3); }
        .btn-register:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4); }
        .error-msg { color: #EF4444; font-size: 14px; margin-top: 15px; display: none; }
        .link-login { margin-top: 20px; display: block; color: #9CA3AF; font-size: 14px; text-decoration: none; }
        .link-login span { color: #8B5CF6; }
        
        /* NOVO: Estilos da Ã¡rea do PIX */
        #area-pix { display: none; margin-top: 10px; padding: 20px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 15px; }
        #area-pix h3 { color: #10B981; font-size: 18px; margin-bottom: 10px; }
        #codigo-pix { width: 100%; height: 90px; padding: 10px; background: #0B0F19; color: #10B981; border: 1px solid #10B981; border-radius: 8px; font-size: 12px; resize: none; outline: none; margin-bottom: 10px; word-break: break-all; }
        .btn-copiar { background: #10B981; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; font-size: 15px; }
        .btn-copiar:hover { background: #059669; }
    </style>
</head>
<body>

    <div class="login-container">
        <div class="logo">ðŸš€</div>
        <h1>Criar Conta</h1>
        <p class="subtitle">Cadastre-se para acessar o Astro</p>

        <div id="form-registro">
            <div class="input-group">
                <label>Nome Completo</label>
                <input type="text" id="nome" placeholder="Digite seu nome">
            </div>
            <div class="input-group">
                <label>Telefone (WhatsApp)</label>
                <input type="text" id="telefone" placeholder="(11) 99999-9999">
            </div>
            <div class="input-group">
                <label>CPF (Apenas para gerar o PIX)</label>
                <input type="text" id="cpf" placeholder="Apenas nÃºmeros">
            </div>

            <div class="error-msg" id="mensagem-erro">Erro ao cadastrar.</div>

            <button class="btn-register" onclick="criarConta()">Assinar Astro (R$ 29,90)</button>
            <a href="login.html" class="link-login" id="link-voltar">JÃ¡ tem uma conta? <span>FaÃ§a login</span></a>
        </div>

        <div id="area-pix">
            <h3>Pagamento PIX Gerado!</h3>
            <p style="font-size: 14px; color: #D1D5DB; margin-bottom: 15px;">Copie o cÃ³digo abaixo e pague no app do seu banco. O seu login serÃ¡ liberado na mesma hora!</p>
            
            <textarea id="codigo-pix" readonly></textarea>
            <button class="btn-copiar" onclick="copiarPix()">ðŸ“‹ Copiar CÃ³digo PIX</button>
            
            <a href="login.html" style="display: block; margin-top: 15px; color: #9CA3AF; text-decoration: underline; font-size: 14px;">JÃ¡ paguei! Ir para o Login</a>
        </div>

    </div>

    <script>
        const urlAstro = 'https://zqvfnykxwlcozvawqgrn.supabase.co';
        const chaveAstro = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxdmZueWt4d2xjb3p2YXdxZ3JuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NDkzNDQsImV4cCI6MjA4NTMyNTM0NH0.CevpF9vP4748mb2vFNsOp5Kq6u7Nfp_100bJcW7ogUQ';
        const meuSupabase = window.supabase.createClient(urlAstro, chaveAstro);

        async function criarConta() {
            const nomeInput = document.getElementById('nome').value.trim();
            const telefoneRaw = document.getElementById('telefone').value.trim();
            const cpfRaw = document.getElementById('cpf').value.trim();
            
            // FILTRO DE SEGURANÃ‡A: Limpa letras e traÃ§os
            const telefoneLimpo = telefoneRaw.replace(/\D/g, ''); 
            const cpfLimpo = cpfRaw.replace(/\D/g, ''); 

            const divErro = document.getElementById('mensagem-erro');
            const btnRegister = document.querySelector('.btn-register');

            if (nomeInput === '' || telefoneLimpo === '' || cpfLimpo === '') {
                divErro.textContent = "Preencha todos os campos (incluindo o CPF vÃ¡lido).";
                divErro.style.display = 'block';
                return;
            }

            btnRegister.textContent = "Gerando seu PIX...";
            btnRegister.disabled = true; // Impede duplo clique
            divErro.style.display = 'none';

            try {
                // 1. SALVA NO SUPABASE COMO BLOQUEADO (false)
                const { data, error } = await meuSupabase
                    .from('clientes')
                    .insert([{ nome: nomeInput, telefone: telefoneLimpo, assinatura_ativa: false }]);

                // Se der erro 23505 (jÃ¡ existe), a gente ignora e gera o pix de novo pro cliente pagar a renovaÃ§Ã£o
                if (error && error.code !== '23505') throw error;

                // 2. PEDE O PIX PARA A DIVPAG
                const dadosDivPag = new URLSearchParams();
                dadosDivPag.append('client_id', 'wrmonteiro_9698775123'); // ðŸ”´ COLOQUE SEU ID AQUI
                dadosDivPag.append('client_secret', '05a6360e459d7cf2e28ba68e0abd94296826a1fe3c7273c5443bcc9bacc6f70c'); // ðŸ”´ COLOQUE SUA CHAVE AQUI
                dadosDivPag.append('nome', nomeInput);
                dadosDivPag.append('cpf', cpfLimpo);
                dadosDivPag.append('valor', '29.90'); // PREÃ‡O DA ASSINATURA
                dadosDivPag.append('descricao', 'Assinatura Mensal Astro');
                
                // O PULO DO GATO: Enviando o Telefone na URL do Webhook
                dadosDivPag.append('urlnoty', `https://astrobot-ebon.vercel.app/api/webhook?telefone=${telefoneLimpo}`);

                const respostaPix = await fetch('https://divpag.com/v3/pix/qrcode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: dadosDivPag
                });

                const pixJson = await respostaPix.json();

                if (pixJson.qrcode) {
                    // SUCECSO! Esconde o formulÃ¡rio e mostra o cÃ³digo do PIX
                    document.getElementById('form-registro').style.display = 'none';
                    document.getElementById('area-pix').style.display = 'block';
                    document.getElementById('codigo-pix').value = pixJson.qrcode;
                } else {
                    throw new Error(pixJson.message || "Erro na DivPag ao gerar o PIX.");
                }

            } catch (err) {
                console.error(err);
                divErro.textContent = err.message || "Sistema indisponÃ­vel. Tente novamente.";
                divErro.style.display = 'block';
                btnRegister.textContent = "Assinar Astro (R$ 29,90)";
                btnRegister.disabled = false;
            }
        }

        // FUNÃ‡ÃƒO DE COPIAR E COLAR DO BOTÃƒO VERDE
        function copiarPix() {
            const codigo = document.getElementById('codigo-pix');
            codigo.select();
            codigo.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(codigo.value);
            
            const btn = document.querySelector('.btn-copiar');
            btn.textContent = "âœ… CÃ³digo Copiado!";
            setTimeout(() => btn.textContent = "ðŸ“‹ Copiar CÃ³digo PIX", 2500);
        }
    </script>
</body>
</html>
