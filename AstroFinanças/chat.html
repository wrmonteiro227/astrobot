// Substitua a funÃ§Ã£o obterFiltrosTemporais e o bloco de consulta por este:

function obterFiltrosTemporais(periodo) {
    const agora = new Date();
    // Normaliza para o inÃ­cio do dia local (00:00:00)
    const hojeInicio = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate()).getTime();
    const umDia = 86400000;

    if (periodo === 'hoje') {
        return { inicio: hojeInicio, fim: Infinity };
    }
    if (periodo === 'ontem') {
        return { inicio: hojeInicio - umDia, fim: hojeInicio - 1 };
    }
    if (periodo === 'mes_atual') {
        return { inicio: new Date(agora.getFullYear(), agora.getMonth(), 1).getTime(), fim: Infinity };
    }
    return { inicio: 0, fim: Infinity };
}

// ... No seu enviarMensagem(), dentro do analise.categoria === 'consulta':

} else if (analise.categoria === 'consulta') {
    const tabela = (analise.tipo === 'tarefas') ? 'tarefas' : 'financas';
    const { data, error } = await meuSupabase.from(tabela).select('*').eq('cliente_id', idUsuario);
    
    if (error) { console.error(error); return; }

    const f = obterFiltrosTemporais(analise.periodo);
    
    // Filtro Robusto: Converte created_at para milissegundos e compara
    let filtrados = data ? data.filter(item => {
        const dataItem = new Date(item.created_at).getTime();
        return dataItem >= f.inicio && dataItem <= f.fim;
    }) : [];

    if (filtrados.length > 0) {
        let r = `Aqui estÃ¡ o seu relatÃ³rio, Tony:\n\n`;
        let total = 0;
        filtrados.forEach(i => {
            const dataObjeto = new Date(i.created_at);
            const dataFormatada = dataObjeto.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
            if (tabela === 'financas') {
                total += i.valor;
                r += `ðŸ“… ${dataFormatada} - R$ ${i.valor.toFixed(2)} (${i.descricao})\n`;
            } else {
                r += `â€¢ ${i.descricao}\n`;
            }
        });
        if (tabela === 'financas') r += `\nðŸ’° TOTAL: R$ ${total.toFixed(2)}`;
        adicionarMensagem(r, 'bot');
    } else {
        adicionarMensagem(`Nenhum registro encontrado para "${analise.periodo}". ðŸ˜Ž`, 'bot');
    }
}
